<!DOCTYPE html>
{% extends 'admintemplate.html' %}
{% load static %}
<head>
  <title>{% block title %}Admin Dashboard{% endblock %}</title> 
  {% block link_section %}
  <link rel="stylesheet" href="{% static '/css/admindelivery.css' %}">
  <link rel="stylesheet" href="{% static '/css/adminorderstyles.css' %}">
  <link rel="stylesheet" href="{% static '/css/adminsubstyles.css' %}">
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/master/qrcode.min.js"></script>
  {% endblock %}
  
</head>

<body>
    {% block delivery_block %}
    <li class="nav-item has-submenu">
        <a href="#" class="nav-link active">
            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-truck" viewBox="0 0 16 16">
                <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5zm1.294 7.456A2 2 0 0 1 4.732 11h5.536a2 2 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456M12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
              </svg>
              
            <span class="nav-link-text">Delivery</span> 
            
        </a>
        <ul class="submenu">
            <li><a class="nav-link" href="{% url 'admindeliverypersonal' %}" ><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
              </svg>Delivery Personnel</a></li>
              <li><a class="nav-link active" href="{% url 'adminassignorder' %}" ><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-person-add" viewBox="0 0 16 16">
                <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0m-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                <path d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z"/>
              </svg>Assign Order</a></li>
              <li><a class="nav-link" href="{% url 'admindeliveryperformance' %}" ><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
              </svg>Delivery Performance</a></li>
              <li><a class="nav-link" href="{% url 'admindeliverylocations' %}" ><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-geo-alt" viewBox="0 0 16 16">
                <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A32 32 0 0 1 8 14.58a32 32 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10"/>
                <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4m0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
              </svg>Delivery Locations</a></li>
        </ul>
    </li>
    {% endblock %}
  {% block main_content %}
  <div class="subnav-container">
    <div class="subnav">
        <h3>Assign Orders</h3>
        <div class="search">
            <input type="text" placeholder="Search...">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </div>
    </div>
    
    </div> 
    <div class="filters">
        <div style="display: flex;align-items: center;gap: 10px;">
            <label for="datefilter">Date</label>
            <input type="date" name="datefilter" id="datefilter">
        </div>
    </div>
    <div class="tablelist">
        <div class="table-container">
            <table id="orderstable" class="tables">
                <thead>
                    <tr>
                        <th>Order Id</th>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Total Amount</th>
                        <th>Payment Status</th>
                        <th>Order Date</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <p id="noResults" style="display: none;font-size: 14px;text-align: center;">No results found...!</p>
        </div>
    </div>
    <div class="overlay-container" id="allordersoverlay">
        <div class="overlay-content">
        <div class="order-details-container" id="order-details">
            <button class="close-overlay" onclick="closeOverlay()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
            
            </svg></button>
            <div class="order-content">
               
            </div>
            <div class="addbutton" style="display: flex;justify-content: center;gap:20px;" id="action-buttons">
                <div style="max-width: 300px;">
                    <select name="deliverypersonnel" id="deliverypersonnel">

                    </select>
                </div>
                <button id="assigndeliveryPersonnel" onclick="assignDeliveryPersonnel()">Assign</button>
            </div>
        </div>
        </div>
    </div>      
<script>
    let ordersData = []; 
    document.addEventListener('DOMContentLoaded', function() {
        getToBeAssignedOrders();
        getDeliveryPersonnels();
        const filters = document.querySelectorAll('.filterselect');
        filters.forEach(filter => {
            filter.addEventListener('change', filterTable);
        });
        const searchInput = document.querySelector('.search input');
        searchInput.addEventListener('input', Search); 
        const dateFilter = document.getElementById('datefilter');
        dateFilter.addEventListener('change', filterTable); 
    });
    function getToBeAssignedOrders(){
        fetch('/admingettobeassignedorders/',{
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        }) 
        .then(response => response.json())
        .then(data => {
            const orderTable = document.querySelector('#orderstable tbody');
            orderTable.innerHTML = ''; 
            ordersData = data.orders;
            if(data.orders.length===0){
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6">No Orders found.</td>';
                orderTable.appendChild(row);
            }
            else{
                
                data.orders.forEach(order => {
                    const row = document.createElement('tr');
                    let statusClass = `status-${order.status.toLowerCase()}`;
                    let paymentStatusClass=`payment-${order.payment_status.toLowerCase()}`
                    let customerStatusClass = `customer-status-${order.customer_status.toLowerCase()}`;

                    row.innerHTML = `
                        <td style="color:#3874ff;font-weight:530;" onclick="viewOrder('${order.order_id}')" id="orderid">${order.order_id}</td>
                        <td style="font-weight:500;color:#31374a;">${order.customer}</td>
                        <td style="font-weight:500;color:#31374a;">${order.email}</td>
                        <td style="color:#31374a;font-weight:600;">Rs. ${order.total_price}</td>
                        <td class="${paymentStatusClass}" style="font-weight:520;">${order.payment_status}</td>
                        <td>${order.created_at}</td>
                    `;
                    orderTable.appendChild(row);
                });
            }
        })
        .catch(error => {
            console.error('Error adding item:', error);
            document.getElementById('displaymessage').textContent = 'Error in getting orders. Please try again later.';
            document.getElementById('success-overlay').style.display = 'flex';
        });
        document.getElementById('confirmMessage').addEventListener('click', () => {
            document.getElementById('success-overlay').style.display = 'none';
        });
    }
    function filterTable() {
        
        const selectedDate = document.getElementById('datefilter').value; 
        const noResultsMessage = document.getElementById('noResults');
        const tableRows = document.querySelectorAll('#orderstable tbody tr'); 
        let hasVisibleRow = false;

        tableRows.forEach(row => {
           
            const dateText = row.querySelector('td:nth-child(9)').textContent; 
            const [day, month, year] = dateText.split(' ')[0].split('-');
            const formattedDate = `${year}-${month}-${day}`;
            const dateMatch = selectedDate === '' || formattedDate === selectedDate;
            if (dateMatch) {
                row.style.display = 'table-row'; 
                hasVisibleRow = true; 
            } else {
                row.style.display = 'none';
            }
        });

        if (!hasVisibleRow) {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none'; 
        }
    }
    function Search() {
        const searchText = this.value.toLowerCase(); 
        const tableRows = document.querySelectorAll('#orderstable tbody tr');
        const noResultsMessage = document.getElementById('noResults');

        let hasVisibleRow = false; 
        tableRows.forEach(row => {
            const orderId = row.querySelector('td:first-child').textContent.toLowerCase().replace(/\s+/g, '').trim();
            const customerName = row.querySelector('td:nth-child(2)').textContent.toLowerCase().replace(/\s+/g, '').trim();
            const customerEmail = row.querySelector('td:nth-child(3)').textContent.toLowerCase().replace(/\s+/g, '').trim();
            const cleanSearchText = searchText.toLowerCase().replace(/\s+/g, '').trim();
            if (orderId.includes(cleanSearchText) || customerName.includes(cleanSearchText) || customerEmail.includes(cleanSearchText)) {
                row.style.display = ''; 
                hasVisibleRow = true;
            } else {
                row.style.display = 'none'; 
            }
        });
        if (!hasVisibleRow) {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none'; 
        }
    }
    

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }
    

    function viewOrder(orderId) {
        const order = ordersData.find(o => o.order_id === orderId);
        if (order) {
            const orderDetailsContainer = document.querySelector('.order-content');

            let orderItemsHTML = '';
            let orderStatusTimelineHTML = '';
            let statusChoices = [];
            if (order.delivery_type === 'Delivery') {
                statusChoices = [
                { status: 'Pending', label: 'Ordered' },
                { status: 'Confirmed', label: 'Confirmed' },
                { status: 'Prepared', label: 'Prepared' },
                { status: 'Shipped', label: 'Shipped' },
                { status: 'Delivered', label: 'Delivered' }
                ];
             } else if (order.delivery_type === 'Pickup') {
                    statusChoices = [
                    { status: 'Pending', label: 'Ordered' },
                    { status: 'Confirmed', label: 'Confirmed' },
                    { status: 'Preparing', label: 'Preparing' },
                    { status: 'Ready to Take', label: 'Ready to Take' },
                    { status: 'Received by Customer', label: 'Received' }
                    ];
                } else if (order.delivery_type === 'Dining') {
                    statusChoices = [
                        { status: 'Pending', label: 'Ordered' },
                        { status: 'Confirmed', label: 'Confirmed' },
                        { status: 'Preparing', label: 'Preparing' },
                        { status: 'Served to Customer', label: 'Served' }
                    ];
                }
                order.items.forEach(item => {
                    orderItemsHTML += `
                        <div class="order-details-item">
                            
                            <div class="item-image-container">
                                <img src="${item.item_image}" class="item-image" alt="${item.item_name}">  
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${item.type === 'NON VEG' ? 'rgb(239, 79, 95)' : 'rgb(27, 166, 114)'}" stroke-width="2" class="bi bi-caret-up-square ${item.type === 'non_veg' ? 'non-veg' : 'veg'}" viewBox="0 0 16 16">
                                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                                    <path d="M3.544 10.705A.5.5 0 0 0 4 11h8a.5.5 0 0 0 .374-.832l-4-4.5a.5.5 0 0 0-.748 0l-4 4.5a.5.5 0 0 0-.082.537"/>
                                </svg>  
                            </div>
                            <div class="item-details"> 
                                <span class="order-details-item-name">${item.item_name}</span>
                                <span class="order-details-item-description">${item.description}</span>
                                <span class="order-details-item-quantity">Quantity: ${item.quantity}</span>
                                    
                            </div>
                            <span class="order-details-item-price">₹${item.price_at_order_time}</span>
                        </div>
                    `;
                });

                let additionalChargesHTML = '';
                if (order.additional_charges && order.additional_charges.length > 0) {
                    order.additional_charges.forEach(charge => {
                        const formattedChargeType = charge.charge_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                            additionalChargesHTML += `
                            <div class="price-summary-item">
                                <span class="price-summary-label">${formattedChargeType} (${charge.value_type === 'fixed' ? 'Fixed' : `${charge.value}%`}):</span>
                                <span class="price-summary-value">₹${charge.calculated_value}</span>
                            </div>
                            `;
                        });
                    }else {
                        additionalChargesHTML = `
                            <div class="price-summary-item">
                                <span class="price-summary-label">Additional Charges:</span>
                                <span class="price-summary-value">None</span>
                            </div>
                        `;
                    }

                    orderStatusTimelineHTML = `
                        <div class="order-status-timeline">
                    `;

                    statusChoices.forEach((choice, index) => {
                        const isActive = order.status === choice.status || (order.status === 'Cancelled' && index === 0); 
                        const isCompleted = (order.status !== 'Pending' && order.status !== 'Cancelled' && index < statusChoices.findIndex(c => c.status === order.status)) || 
                        (order.status === 'Delivered' && choice.status === 'Delivered') ||
                        (order.status === 'Received by Customer' && choice.status === 'Received by Customer') ||
                        (order.status === 'Served to Customer' && choice.status === 'Served to Customer');

                        const isLineActive = isCompleted && index < statusChoices.length - 1;

                        orderStatusTimelineHTML += `
                            <div class="status-point ${isActive ? 'active' : (isCompleted ? 'completed' : '')}" data-status="${choice.label}"></div>
                            ${index < statusChoices.length - 1 ? `<div class="status-line ${isLineActive ? 'active' : (order.status === 'Cancelled' ? 'cancelled' : '')}"></div>` : ''}
                        `;
                    });

                    orderStatusTimelineHTML += `
                        </div>
                    `;

                    let refundSectionHTML = '';
                    if (order.status === 'Cancelled') {
                        refundSectionHTML = `
                            <div class="refund-section">
                                <p><span class="refund-status">Refund Completed</span> - ${order.cancel_reason ? order.cancel_reason : 'No reason provided'}</p>
                            </div>
                        `;
                    }
                    const qrCodeText = `Order ID: ${order.order_id}\nDate Ordered: ${order.created_at}\nPhone Number: ${order.phone_number}`; 
                    orderDetailsContainer.innerHTML = `
                        <div class="order-info-section">
                            <div class="order-details-header">
                                <h3>Order Details</h3>

                                <div class="order-details-summary-item">
                                    <h4 class="orer-details-orderid" style="color:#3874ff;">${order.order_id}</h4>
                                    <span class="order-details-date">${order.created_at}</span>
                                </div>
                                <span class="order-details-name" style="color:#333;font-weight:520;">${order.customer}</span>
                                <span class="order-details-number" style="color:#333;font-weight:520;">This Order is tracking by: ${order.phone_number}</span>
                                <span class="order-details-email" style="color:#333;font-weight:520;">${order.email}</span>
                                <div class="order-details-summary-item">
                                    <span class="order-details-summary-label">Status:</span>
                                    <span class="order-details-status">${order.status}</span>
                                </div>
                            
                                <div class="order-details-summary-item">
                                    <span class="order-details-summary-label">Customer Status:</span>
                                    <span class="order-details-summary-value">${order.customer_status}</span>
                                </div>
                                ${
                                    (order.status === 'Delivered' && order.delivery_type === 'Delivery') ?
                                    `
                                        <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Delivery Place:</span>
                                            <span class="order-details-summary-value">${order.delivery_address}</span>
                                        </div>
                                        <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Delivered By:</span>
                                            <span class="order-details-summary-value">${order.delivery_person}</span>
                                        </div>
                                        <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Delivered:</span>
                                            <span class="order-details-summary-value">${order.delivered_at}</span>
                                        </div>
                                    ` : ''
                                }
                                ${
                                    (order.status !== 'Delivered' && order.status !== 'shipped' && order.delivery_type === 'Delivery') ?
                                    `
                                        <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Delivery Place:</span>
                                            <span class="order-details-summary-value">${order.delivery_address}</span>
                                        </div>
                                    ` : ''
                                }
                                ${
                                    (order.status == 'Cancelled') ?
                                    `
                                        <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Cancelled At:</span>
                                            <span class="order-details-summary-value">${order.cancelled_at}</span>
                                        </div>
                                         <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Cancel Reason:</span>
                                            <span class="order-details-summary-value">${order.cancel_reason}</span>
                                        </div>
                                    ` : ''
                                }
                                ${
                                    (order.status === 'Shipped' && order.delivery_type === 'Delivery') ?
                                    `
                                        <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Delivery Place:</span>
                                            <span class="order-details-summary-value">${order.delivery_address}</span>
                                        </div>
                                        <div class="order-details-summary-item">
                                            <span class="order-details-summary-label">Assigned to:</span>
                                            <span class="order-details-summary-value">${order.delivery_person}</span>
                                        </div>
                                    ` : ''
                                }

                                <div id="qrcode"></div>     
                            </div>  
                        </div>

                        <div class="order-items-section">
                            <h3>Ordered Items</h3>
                            ${orderItemsHTML}
                            ${orderStatusTimelineHTML}
                        </div>

                        <div class="price-summary-container order-summary-section">
                            <h3>Order Payment Details</h3>
                            <div class="price-summary-item">
                                <span class="price-summary-label">Item Total:</span>
                                <span class="price-summary-value">₹${order.total_item_price}</span>
                            </div>
                            ${additionalChargesHTML}
                            <hr>
                            <div class="price-summary-item">
                                <span class="price-summary-label">Total:</span>
                                <span class="price-summary-value total-price">₹${order.total_price}</span>
                            </div>
                        </div>
                        <div class="payment-details-section">
                            <h3>Payment Mode</h3>
                            <div class="order-details-summary-item">
                                <span class="order-details-summary-label">Payment Method:</span>
                                <span class="order-details-summary-value">${order.payment_method}</span>
                            </div>
                            <div class="order-details-summary-item">
                                <span class="order-details-summary-label">Transaction ID:</span>
                                <span class="order-details-summary-value">${order.transaction_id}</span>
                            </div>
                            <div class="order-details-summary-item">
                                <span class="order-details-summary-label">Payment Amount:</span>
                                <span class="order-details-summary-value">₹${order.payment_amount}</span>
                            </div>
                            <div class="order-details-summary-item">
                                <span class="order-details-summary-label">Payment Status:</span>
                                <span class="order-details-summary-value">${order.payment_status}</span>
                            </div>
                            <div class="order-details-summary-item">
                                <span class="order-details-summary-label">Payment Date:</span>
                                <span class="order-details-summary-value">${order.payment_date}</span>
                            </div>
                        </div>
                        ${refundSectionHTML} 
                    `;
                    generateQRCode(qrCodeText); 
                    document.getElementById('allordersoverlay').style.display = 'flex';
                } else {
                    console.error('Order not found in data:', orderId);
                }
            }
    function generateQRCode(text) {
        new QRCode(document.getElementById("qrcode"), {
        text: text,
        width: 150,  
        height: 150, 
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
        });
    }
    function getDeliveryPersonnels() {
        fetch('/admingetdeliverypersonnels/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
        })
        .then(response => response.json())
        .then(data => {
        if (data.success) {
            const deliveryPersonnelSelect = document.getElementById('deliverypersonnel'); 
            deliveryPersonnelSelect.innerHTML = ''; 
            const initialOption = document.createElement('option');
            initialOption.value = ""; 
            initialOption.text = "Select Delivery Personnel";
            initialOption.disabled = true;
            initialOption.selected=true;
            deliveryPersonnelSelect.appendChild(initialOption);
            data.data.forEach(personnel => {
                const option = document.createElement('option');
                option.value = personnel.email;
                option.text = `${personnel.first_name} (${personnel.phone_number})`;
                deliveryPersonnelSelect.appendChild(option);
            });
        } else {
            console.error('Error fetching delivery personnels:', data.error);
            document.getElementById('displaymessage').textContent = 'Error fetching personnel: ' + data.error;
            document.getElementById('success-overlay').style.display = 'flex';
        }
        })
        .catch(error => {
        console.error('Error fetching delivery personnels:', error);
        document.getElementById('displaymessage').textContent = 'Error fetching personnel. Please try again later.';
        document.getElementById('success-overlay').style.display = 'flex';
        });
    }
    function assignDeliveryPersonnel(){
        const orderId = document.getElementById('orderid').textContent; 
        const order = ordersData.find(o => o.order_id === orderId);
        const deliveryPersonnel=document.getElementById('deliverypersonnel').value;
            if (order) {
                fetch('/adminassignordertodelivery/',{
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({'order_id': order.order_id,'delivery_personnel':deliveryPersonnel})
                }) 
                .then(response => response.json())
                .then(data => {
                    if(data.success){
                        document.getElementById('displaymessage').textContent = 'Order Assigned!';
                        document.getElementById('success-overlay').style.display = 'flex';
                        closeOverlay();
                        getToBeAssignedOrders();
                    }
                    else{
                        document.getElementById('displaymessage').textContent = 'Something went wrong. Please try again.';
                        document.getElementById('success-overlay').style.display = 'flex';
                    }
                });
            } else {
                document.getElementById('displaymessage').textContent = 'Something went wrong. Please try again.';
                document.getElementById('success-overlay').style.display = 'flex';
                console.error('Order not found to confirm:', orderId);
            }
            document.getElementById('confirmMessage').addEventListener('click', () => {
                document.getElementById('success-overlay').style.display = 'none';
        });
    }
    function closeOverlay() {
        document.getElementById('allordersoverlay').style.display = 'none';
    }
    function openCancelForm(){
        document.getElementById('cancelformoverlay').style.display='flex';
    }
    function closeCancelForm(){
        document.getElementById('cancelformoverlay').style.display='none';
    }
    </script>
  {% endblock %} 
</body>
</html>