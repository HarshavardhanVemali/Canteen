<!DOCTYPE html>
{% extends 'admintemplate.html' %}
{% load static %}
<head>
  <title>{% block title %}Admin Dashboard{% endblock %}</title> 
  {% block link_section %}
  <link rel="stylesheet" href="{% static '/css/adminsubstyles.css' %}">
  <link rel="stylesheet" href="{% static '/css/adminorderstyles.css' %}">
  {% endblock %}
  
</head>

<body>
    {% block orders_block %}
    <li class="nav-item has-submenu">
        <a href="#" class="nav-link active">
            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart4" viewBox="0 0 16 16">
                <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0"/>
              </svg>
            <span class="nav-link-text">Orders</span> 
            
        </a>
        <ul class="submenu">
            <li class="nav-item"><a class="nav-link" href="{% url 'adminallorders' %}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/>
              </svg>All Orders</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'adminneworders' %}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
              </svg>New Orders</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'admindeliveredorders' %}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                </svg>Delivered</a></li>
              <li class="nav-item"><a class="nav-link active" href="{% url 'admincancelledorders' %}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293z"/>
              </svg>Cancelled Orders</a></li>
            
        </ul>
    </li>
    {% endblock %}
    {% block main_content %}
    <style>
    
    </style>
        <div class="subnav-container">
            <div class="subnav">
                <h3>Cancelled Orders</h3>
                <div class="search">
                    <input type="text" placeholder="Search...">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
            </div>
            
        </div> 
        <div class="filters">
            <div style="display: flex;align-items: center;gap: 10px;">
                <label for="datefilter">Date</label>
                <input type="date" name="datefilter" id="datefilter">
            </div>
            <div style="display: flex;align-items: center;gap: 10px;">
                <label for="paymentstatus">Payment Status</label>
                <select name="paymentstatus" id="paymentstatus" class="filterselect" required>
                    <option value="" selected>All</option>
                    <option value="Pending">Pending</option>
                    <option value="Success">Success</option>
                    <option value="Failed">Failed</option>
                </select>
            </div>

        </div>
        <div class="tablelist">
            <div class="table-container">
                <table id="orderstable" class="tables">
                    <thead>
                        <tr>
                            <th>Order Id</th>
                            <th>Customer</th>
                            <th>Email</th>
                            <th>Total Amount</th>
                            <th>Payment Status</th>
                            <th>Status</th>
                            <th>Order Date</th>
                            <th>Cancelled Date</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <p id="noResults" style="display: none;font-size: 14px;text-align: center;">No results found...!</p>
            </div>
        </div>
        <div class="overlay-container" id="allordersoverlay">
            <div class="overlay-content">
              <div class="order-details-container" id="order-details">
                <button class="close-overlay" onclick="closeOverlay()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                  
                </svg></button>
                <div class="order-content">
                    <div class="order-content-left">
                        <div class="ordered-items">
                            <h3 id="order-id">Order</h3>
                            <table id="items-table" class="tables">
                              <thead>
                                <tr>
                                  <th></th>
                                  <th>Item</th>
                                  <th>Quantity</th>
                                  <th>Type</th>
                                  <th>Availability</th>
                                  <th>Price</th>   
                                </tr>
                              </thead>
                              <tbody>
                              </tbody>
                            </table>
                        </div>
                        <div style="margin-top:20px ;">
                            <h3>Order Status</h3>
                            <div class="order-status-timeline">
                               
                            </div>
                        </div> 
                        <div class="price-container">
                            <h3>Price Summary</h3>
                            <div class="price-content-container">
                                <div class="price-item">
                                    <div class="label" id="total-items-price-label">Item Total</div>
                                    <div class="price" id="total-items-price"></div>
                                </div>
                                <div id="additional-costs">
                                   
                                </div>
                                <div class="price-item">
                                    <div class="label">Total</div>
                                    <div class="price" id="total-cost"></div>
                                </div>
                            </div>
                        </div>                       
                    </div>
                    <div class="order-content-right" style="display: flex;flex-direction: column;gap: 20px;">
                        <div class="order-info">
                            
                            <div class="customer-details">
                                <h3>Customer Details</h3>
                                <div class="row">
                                    <label for="customer-name">Name:</label>
                                    <p id="customer-name"></p>
                                </div>
                                <div class="row">
                                    <label for="customer-email">Email:</label>
                                    <p id="customer-email"></p>
                                </div>
                                <div class="row">
                                    <label for="customer-phonenumber">Mobile Number:</label>
                                    <p id="customer-phonenumber"></p>
                                </div>
                                <div class="row">
                                    <label for="delivery-type">Delivery Type:</label> 
                                    <p id="delivery-type"></p>
                                </div>
                                <div class="row">
                                    <label for="order-date">Order Date:</label>
                                    <p id="order-date"></p>
                                </div>
                                <div class="row">
                                    <label for="cancelled-date">Cancelled Date:</label>
                                    <p id="cancelled-date"></p>
                                </div>   
                            </div>
                            <div class="order-summary">
                                <h3>Summary</h3> 
                                <div class="row">
                                    <label for="Total Amount">Total Amount:</label>
                                    <p id="total-amount"></p>
                                </div>
                                <div class="row">
                                    <label for="payment-status">Payment Status:</label>
                                    <p id="payment-status"></p>
                                </div>
                            </div>
                          </div>
                          <div class="payment-details">
                            <h3>Payment Details</h3>
                            <div class="row">
                                <label for="payment-method">Payment Method:</label>
                                <p id="payment-method"></p>
                            </div>
                            <div class="row">
                                <label for="transaction-id">Transaction ID:</label>
                                <p id="transaction-id"></p>
                            </div>
                            <div class="row">
                                <label for="payment-amount">Payment Amount:</label>
                                <p id="payment-amount"></p>
                            </div>
                            <div class="row">
                                <label for="payment-date">Payment Date:</label>
                                <p id="payment-date"></p>
                            </div>
                          </div>
                    </div>
                </div>
              </div>
            </div>
        </div>      
        <script>
            let ordersData = []; 
            document.addEventListener('DOMContentLoaded', function() {
                getNewOrder();
                const filters = document.querySelectorAll('.filterselect');
                filters.forEach(filter => {
                    filter.addEventListener('change', filterTable);
                });
                const searchInput = document.querySelector('.search input');
                searchInput.addEventListener('input', Search); 
                const dateFilter = document.getElementById('datefilter');
                dateFilter.addEventListener('change', filterTable); 
            });
            function getNewOrder(){
                fetch('/admingetcancelledorders/',{
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                }) 
                .then(response => response.json())
                .then(data => {
                    const orderTable = document.querySelector('#orderstable tbody');
                    orderTable.innerHTML = ''; 
                    ordersData = data.orders;
                    if(data.orders.length===0){
                        const row = document.createElement('tr');
                        row.innerHTML = '<td colspan="8">No Orders found.</td>';
                        orderTable.appendChild(row);
                    }
                    else{
                        
                        data.orders.forEach(order => {
                            const row = document.createElement('tr');
                            let statusClass = `status-${order.status.toLowerCase()}`;
                            let paymentStatusClass=`payment-${order.payment_status.toLowerCase()}`
                            let customerStatusClass = `customer-status-${order.customer_status.toLowerCase()}`;
                            let deliveryClass = `delivery-${order.delivery_type.toLowerCase()}`; 

                            row.innerHTML = `
                                <td style="color:#3874ff;font-weight:530;" onclick="viewOrder('${order.order_id}')" id="orderid">${order.order_id}</td>
                                <td style="font-weight:500;color:#31374a;">${order.customer}</td>
                                <td style="font-weight:500;color:#31374a;">${order.email}</td>
                                <td style="color:#31374a;font-weight:600;">Rs. ${order.total_price}</td>
                                <td class="${paymentStatusClass}" style="font-weight:520;">${order.payment_status}</td>
                                <td class="${statusClass}" style="font-weight:520;">${order.status}</td>
                                <td>${order.created_at}</td>
                                <td>${order.cancelled_at}</td>
                            `;
                            orderTable.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error adding item:', error);
                    document.getElementById('displaymessage').textContent = 'Error in getting orders. Please try again later.';
                    document.getElementById('success-overlay').style.display = 'flex';
                });
                document.getElementById('confirmMessage').addEventListener('click', () => {
                    document.getElementById('success-overlay').style.display = 'none';
                });
            }
            function filterTable() {

                const selectedPaymentStatus = document.getElementById('paymentstatus').value.toLowerCase();
                const selectedDate = document.getElementById('datefilter').value; 
                const noResultsMessage = document.getElementById('noResults');
                const tableRows = document.querySelectorAll('#orderstable tbody tr'); 
                let hasVisibleRow = false;

                tableRows.forEach(row => {
                    const paymentStatus = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
                    const dateText = row.querySelector('td:nth-child(7)').textContent; 
                    const [day, month, year] = dateText.split(' ')[0].split('-');
                    const formattedDate = `${year}-${month}-${day}`;

                    const paymentStatusMatch = selectedPaymentStatus === '' || paymentStatus === selectedPaymentStatus;

                    const dateMatch = selectedDate === '' || formattedDate === selectedDate;

                    if (paymentStatusMatch && dateMatch) {
                        row.style.display = 'table-row'; 
                        hasVisibleRow = true; 
                    } else {
                        row.style.display = 'none';
                    }
                });

                if (!hasVisibleRow) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none'; 
                }
            }
            function Search() {
                const searchText = this.value.toLowerCase(); 
                const tableRows = document.querySelectorAll('#orderstable tbody tr');
                const noResultsMessage = document.getElementById('noResults');

                let hasVisibleRow = false; 
                tableRows.forEach(row => {
                    const orderId = row.querySelector('td:first-child').textContent.toLowerCase().replace(/\s+/g, '').trim();
                    const customerName = row.querySelector('td:nth-child(2)').textContent.toLowerCase().replace(/\s+/g, '').trim();
                    const customerEmail = row.querySelector('td:nth-child(3)').textContent.toLowerCase().replace(/\s+/g, '').trim();
                    const cleanSearchText = searchText.toLowerCase().replace(/\s+/g, '').trim();
                    if (orderId.includes(cleanSearchText) || customerName.includes(cleanSearchText) || customerEmail.includes(cleanSearchText)) {
                        row.style.display = ''; 
                        hasVisibleRow = true;
                    } else {
                        row.style.display = 'none'; 
                    }
                });
                if (!hasVisibleRow) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none'; 
                }
            }
            

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                    }
                }
                }
                return cookieValue;
            }
            


            function viewOrder(orderId) {
                const order = ordersData.find(o => o.order_id === orderId);
                if (order) {
                    let statusChoices = [];
                    let orderStatusTimelineHTML = '';
                    if (order.delivery_type === 'Delivery') {
                        statusChoices = [
                        { status: 'Pending', label: 'Ordered' },
                        { status: 'Confirmed', label: 'Confirmed' },
                        { status: 'Prepared', label: 'Prepared' },
                        { status: 'Shipped', label: 'Shipped' },
                        { status: 'Delivered', label: 'Delivered' }
                        ];
                    } else if (order.delivery_type === 'Pickup') {
                        statusChoices = [
                        { status: 'Pending', label: 'Ordered' },
                        { status: 'Confirmed', label: 'Confirmed' },
                        { status: 'Preparing', label: 'Preparing' },
                        { status: 'Ready to Take', label: 'Ready to Take' },
                        { status: 'Received by Customer', label: 'Received' }
                        ];
                    } else if (order.delivery_type === 'Dining') {
                        statusChoices = [
                        { status: 'Pending', label: 'Ordered' },
                        { status: 'Confirmed', label: 'Confirmed' },
                        { status: 'Preparing', label: 'Preparing' },
                        { status: 'Served to Customer', label: 'Served' }
                        ];
                    }
                    orderStatusTimelineHTML = `
                        <div class="order-status-timeline">
                    `;

                    statusChoices.forEach((choice, index) => {
                        const isActive = order.status === choice.status || (order.status === 'Cancelled' && index === 0); 
                        const isCompleted = (order.status !== 'Pending' && order.status !== 'Cancelled' && index < statusChoices.findIndex(c => c.status === order.status)) || 
                        (order.status === 'Delivered' && choice.status === 'Delivered') ||
                        (order.status === 'Received by Customer' && choice.status === 'Received by Customer') ||
                        (order.status === 'Served to Customer' && choice.status === 'Served to Customer');

                        const isLineActive = isCompleted && index < statusChoices.length - 1;

                        orderStatusTimelineHTML += `
                            <div class="status-point ${isActive ? 'active' : (isCompleted ? 'completed' : '')}" data-status="${choice.label}"></div>
                            ${index < statusChoices.length - 1 ? `<div class="status-line ${isLineActive ? 'active' : (order.status === 'Cancelled' ? 'cancelled' : '')}"></div>` : ''}
                        `;
                    });

                    orderStatusTimelineHTML += `
                        </div>
                    `;
                    document.querySelector('.order-status-timeline').innerHTML = orderStatusTimelineHTML; 
                    document.getElementById('order-id').textContent = `Order: ${order.order_id}`;
                    document.getElementById('customer-name').textContent = `${order.customer}`;
                    document.getElementById('customer-email').textContent = `${order.email}`;
                    document.getElementById('customer-phonenumber').textContent=`${order.phone_number}`;
                    document.getElementById('total-amount').textContent = `Rs. ${order.total_price}`;
                    document.getElementById('payment-status').textContent = `${order.payment_status}`;
                    document.getElementById('delivery-type').textContent = `${order.delivery_type}`;
                    document.getElementById('order-date').textContent = `${order.created_at}`;
                    document.getElementById('cancelled-date').textContent=`${order.cancelled_at}`;
                    document.getElementById('payment-method').textContent = `${order.payment_method}`;
                    document.getElementById('transaction-id').textContent = `${order.transaction_id}`;
                    document.getElementById('payment-amount').textContent = `${order.payment_amount}`;
                    document.getElementById('payment-date').textContent = `${order.payment_date}`;

                    const itemsTable = document.getElementById('items-table').getElementsByTagName('tbody')[0];
                    itemsTable.innerHTML = ''; 
                    order.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <img src="${item.item_image}" class="item-image" alt="${item.item_name}">
                            </td>
                            <td style="color:#3874ff;">${item.item_name}</td>
                            <td>${item.quantity}</td>
                            <td style="color: ${item.type === 'NON VEG' ? 'rgb(239, 79, 95)' : 'rgb(27, 166, 114)'};">${item.type}</td>
                            <td style="color:${item.is_available ? 'green' : 'red'}">${item.is_available ? 'Available' : 'Unavailable'}</td>
                            <td style="color:#31374a;font-weight:600;">Rs. ${item.price_at_order_time}</td>
                            
                        `;
                        itemsTable.appendChild(row);
                    });
                    const row=document.createElement('tr');
                    row.innerHTML=`
                        <td colspan="5">Item Total</td>
                        <td style="color:#31374a;font-weight:600;">Rs. ${order.total_item_price}</td>
                    `
                    itemsTable.appendChild(row);
                    const itemTotalPrice = parseFloat(order.total_item_price);
                    document.getElementById('total-items-price').textContent = `Rs. ${itemTotalPrice.toFixed(2)}`;

                    const additionalCharges = order.additional_charges || [];
                    const additionalCostsContainer = document.getElementById('additional-costs');


                    additionalCostsContainer.innerHTML = ''; 

                    let totalAdditionalCost = 0;
                    additionalCharges.forEach(charge => {
                        let chargeAmount = parseFloat(charge.calculated_value); 
                        totalAdditionalCost += chargeAmount; 

                        const chargeDiv = document.createElement('div');
                        chargeDiv.className = 'price-item'; 
                        const formattedChargeType = charge.charge_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        chargeDiv.innerHTML = `
                            <div class="label">${formattedChargeType} (${charge.value_type === 'fixed' ? 'Fixed' : `${charge.value}%`}):</div>
                            <div class="price">Rs. ${chargeAmount.toFixed(2)}</div>
                        `;
                        additionalCostsContainer.appendChild(chargeDiv);
                    });

                    const totalCost = itemTotalPrice + totalAdditionalCost;

                    document.getElementById('total-cost').textContent = `Rs. ${totalCost.toFixed(2)}`;
                    document.getElementById('allordersoverlay').style.display = 'flex';
                } else {
                    console.error('Order not found in data:', orderId);
                }
            }
            

            function closeOverlay() {
                document.getElementById('allordersoverlay').style.display = 'none';
            }
            function openCancelForm(){
                document.getElementById('cancelformoverlay').style.display='flex';
            }
            function closeCancelForm(){
                document.getElementById('cancelformoverlay').style.display='none';
            }
        </script>
    {% endblock %} 
</body>
</html>